<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Copilot Chat Demo</title>
  <style>
    body { font-family: sans-serif; margin: 2rem; }
    #chat { border: 1px solid #ccc; padding: 1rem; width: 480px; height: 300px; overflow-y: auto; }
    .bot { color: blue; margin: 0.25rem 0; }
    .user { color: green; margin: 0.25rem 0; }
  </style>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
  <div id="app" class="m-4 p-3 w-[800px] relative">
    <h1 class="text-2xl font-bold mb-2">Copilot Chat</h1>
    <div id="chat" class="w-full"></div>
    <div class="mt-4">
      <input id="input" placeholder="Type a message" class="border shadow rounded px-4 py-2" />
      <button id="send" class="border border-green-400 bg-green-300 hover:bg-green-200 rounded shadow px-4 py-2">Send</button>
    </div>
  </div>

  <script>
    const API_BASE = 'http://localhost:3001';
    let conversationId = null;
    let token = null;
    let watermark = null;
    let userId = null;

    const chatBox = document.getElementById('chat');
    const input = document.getElementById('input');
    const sendBtn = document.getElementById('send');

    function appendMessage(sender, text) {
      const div = document.createElement('div');
      div.className = sender;
      div.textContent = `${sender}: ${text}`;
      chatBox.appendChild(div);
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    async function getToken() {
      const res = await fetch(`${API_BASE}/api/directline/token`, { method: 'POST', headers: { 'Content-Type': 'application/json' } });
      const data = await res.json();
      if (!res.ok) {
        appendMessage('bot', `Token error: ${data.detail || data.error}`);
        throw new Error('Token failed');
      }
      token = data.token;
      userId = data.userId;
    }

    async function sendMessage() {
      const text = input.value.trim();
      if (!text || !token || !userId) return;
      appendMessage('user', text);
      input.value = '';

      const res = await fetch(`${API_BASE}/api/chat`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ text, token, conversationId, watermark, userId })
      });

      const data = await res.json();
      if (!res.ok) {
        appendMessage('bot', `Error: ${data.detail || data.error}`);
        return;
      }

      conversationId = data.conversationId;
      watermark = data.watermark;

      (data.activities || [])
        .filter(a => a.from && a.from.id !== userId)
        .forEach(r => appendMessage('bot', r.text || '[no text activity]'));
    }

    sendBtn.addEventListener('click', sendMessage);
    input.addEventListener('keypress', e => { if (e.key === 'Enter') sendMessage(); });

    // boot
    getToken().catch(console.error);
  </script>
</body>
</html>
